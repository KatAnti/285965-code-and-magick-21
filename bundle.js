(()=>{"use strict";(()=>{const e=document.querySelector(".setup"),t=(e,t)=>Math.floor(e+Math.random()*(t+1-e));window.util={dialog:e,coatColors:["rgb(101, 137, 164)","rgb(241, 43, 107)","rgb(146, 100, 161)","rgb(56, 159, 117)","rgb(215, 210, 55)","rgb(0, 0, 0)"],eyesColors:["black","red","blue","yellow","green"],surnames:["да Марья","Верон","Мирабелла","Вальц","Онопко","Топольницкая","Нионго","Ирвинг"],names:["Иван","Хуан Себастьян","Мария","Кристоф","Виктор","Юлия","Люпита","Вашингтон"],fireballColors:["#ee4830","#30a8ee","#5ce6c0","#e848d5","#e6e848"],getRandom:t,getFeature:e=>e[t(0,e.length-1)],createErrMessage:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),(()=>{const e=85,t=150,i=40,s=50,n="rgba(255, 0, 0, 1)",a=(e,t,i,s,n,a)=>{e.fillStyle=a,e.fillRect(t,i,s,n)},r=(e,t,i,s)=>{e.fillStyle="black",e.textBaseline="hanging",e.font="16px PT Mono",e.fillText(s,t,i)};window.renderStatistics=function(o,d,l){const c=(e=>{let t=e[0];return e.forEach((e=>{t<e&&(t=e)})),t})(l);let u=100+s,h=10+e;((e,t,i)=>{e.fillStyle="rgba(0, 0, 0, 0.7)",a(e,110,20,420,270),e.fillStyle="#fff",a(e,100,10,420,270)})(o),((e,t,i,s)=>{"Ура вы победили! \nСписок результатов: ".split("\n").forEach((t=>{r(e,130,i,t),i+=20}))})(o,0,30),d.forEach(((e,d)=>{const w="Вы"===e,m=t*l[d]/c,g=h+(t-m);o.fillStyle=w?n:`hsl(237, ${window.util.getRandom(10,70)}%, ${window.util.getRandom(10,70)}%)`,a(o,u,g,i,m),r(o,u,255,e),r(o,u,g-15,Math.round(l[d])),u+=i+s}))}})(),(()=>{const e=(e,t,i,s)=>{const n=new XMLHttpRequest;let a="POST"===e?"https://21.javascript.pages.academy/code-and-magick":"https://21.javascript.pages.academy/code-and-magick/data";n.responseType="json",n.addEventListener("load",(()=>{200===n.status?t(n.response):i("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(()=>{i("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{i("Запрос не успел выполниться за "+n.timeout+"мc")})),n.timeout=1e4,n.open(e,a),s?n.send(s):n.send()};window.backend={load:(t,i)=>{e("GET",t,i)},save:(t,i,s)=>{e("POST",i,s,t)}}})(),(()=>{const e=document.querySelector(".setup-player"),t=e.querySelector('input[name="coat-color"]'),i=e.querySelector('input[name="eyes-color"]'),s=e.querySelector('input[name="fireball-color"]');let n={onEyesChange:()=>{},onCoatChange:()=>{}};const a=(e,t,i)=>(e.target.matches(".setup-fireball")?e.target.style.backgroundColor=t:e.target.style.fill=t,i.value=t,t);e.addEventListener("click",(e=>{if(e.target&&e.target.matches(".setup-wizard .wizard-coat")){const i=a(e,window.util.getFeature(window.util.coatColors),t);n.onCoatChange(i)}if(e.target&&e.target.matches(".setup-wizard .wizard-eyes")){const t=a(e,window.util.getFeature(window.util.eyesColors),i);n.onEyesChange(t)}e.target&&e.target.matches(".setup-fireball")&&a(e,window.util.getFeature(window.util.fireballColors),s)})),window.wizard={setCoatChangeHandler:e=>{n.onCoatChange=e},setEyesChangeHandler:e=>{n.onEyesChange=e}}})(),window.debounce=e=>{let t=null;return(...i)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...i)}),500)}},(()=>{const e=document.querySelector(".setup-similar"),t=document.querySelector(".setup-similar-list"),i=document.createDocumentFragment(),s=document.querySelector(".setup-wizard-form"),n=document.querySelector("#similar-wizard-template").content.querySelector(".setup-similar-item");let a="rgb(101, 137, 164)",r="black",o=[];const d=e=>{const t=n.cloneNode(!0),i=t.querySelector(".wizard-coat"),s=t.querySelector(".wizard-eyes"),a=t.querySelector(".setup-similar-label");return s.style.fill=e.colorEyes,i.style.fill=e.colorCoat,a.textContent=e.name,t},l=s=>{const n=s.length>4?4:s.length;t.innerHTML="";for(let e=0;e<n;e++)t.appendChild(d(s[e]));t.appendChild(i),e.classList.remove("hidden")},c=function(e){let t=0;return e.colorCoat===a&&(t+=2),e.colorEyes===r&&(t+=1),t},u=()=>{l(o.sort((function(e,t){return c(t)-c(e)})))},h=function(e){window.util.createErrMessage(e)};window.backend.load((function(e){o=e,l(o),u()}),h),s.addEventListener("submit",(e=>{e.preventDefault(),window.backend.save(new FormData(s),(()=>{window.util.dialog.classList.add("hidden")}),h)})),window.wizard.setEyesChangeHandler(window.debounce((e=>{r=e,u()}))),window.wizard.setCoatChangeHandler(window.debounce((e=>{a=e,u()})))})(),(()=>{const e="Enter",t=document.querySelector(".setup-open"),i=document.querySelector(".setup-close"),s=document.querySelector('input[name="username"]'),n=e=>{"Escape"===e.key&&s!==document.activeElement&&(e.preventDefault(),r())},a=()=>{window.util.dialog.classList.remove("hidden"),document.addEventListener("keydown",n)},r=()=>{window.util.dialog.classList.add("hidden"),window.util.dialog.style="",document.removeEventListener("keydown",n)};t.addEventListener("click",(()=>{a()})),t.addEventListener("keydown",(t=>{t.key===e&&a()})),i.addEventListener("click",(()=>{r()})),i.addEventListener("keydown",(t=>{t.key===e&&r()}))})(),(()=>{const e=window.util.dialog.querySelector(".upload");e.addEventListener("mousedown",(t=>{t.preventDefault();let i=!1,s={x:t.clientX,y:t.clientY};const n=e=>{e.preventDefault(),i=!0;const t=s.x-e.clientX,n=s.y-e.clientY;s={x:e.clientX,y:e.clientY},window.util.dialog.style.top=window.util.dialog.offsetTop-n+"px",window.util.dialog.style.left=window.util.dialog.offsetLeft-t+"px"},a=t=>{if(t.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a),i){const t=e=>{e.preventDefault(),document.removeEventListener("click",t)};e.addEventListener("click",t)}};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a)}))})(),window.GameConstants={Fireball:{size:fireballSize||24,speed:getFireballSpeed||function(e){return e?2:5}},Wizard:{speed:wizardSpeed||2,width:wizardWidth||61,getHeight:getWizardHeight||function(e){return 1.377*e},getX:getWizardX||function(e){return e/3},getY:getWizardY||function(e){return e-100}}},window.Game=function(){var e=300,t=700,i=["Кекс","Катя","Игорь"],s={},n="-reversed";s[0]={width:61,height:84,url:"img/wizard.gif"},s[0+n]={width:61,height:84,url:"img/wizard-reversed.gif"},s[1]={width:24,height:24,url:"img/fireball.gif"};var a={0:function(i,s,n){s.keysPressed.UP&&i.y>0&&(i.direction=-9&i.direction,i.direction=4|i.direction,i.y-=i.speed*n*2),s.keysPressed.UP||i.y<e-i.height&&(i.direction=-5&i.direction,i.direction=8|i.direction,i.y+=i.speed*n/3),s.keysPressed.LEFT&&(i.direction=-3&i.direction,i.direction=1|i.direction,i.x-=i.speed*n),s.keysPressed.RIGHT&&(i.direction=-2&i.direction,i.direction=2|i.direction,i.x+=i.speed*n),i.y<0&&(i.y=0),i.y>e-i.height&&(i.y=e-i.height),i.x<0&&(i.x=0),i.x>t-i.width&&(i.x=t-i.width)},1:function(e,i,s){1&e.direction&&(e.x-=e.speed*s),2&e.direction&&(e.x+=e.speed*s),(e.x<0||e.x>t)&&(e.state=1)}},r={CONTINUE:0,WIN:1,FAIL:2,PAUSE:3,INTRO:4},o={0:function(e){return e.garbage.filter((function(e){return 1===e.type})).filter((function(e){return e.x<10&&e.y>240}))[0]?r.WIN:r.CONTINUE}},d={0:function(i){return i.objects.push({direction:2,height:window.GameConstants.Wizard.getHeight(window.GameConstants.Wizard.width),speed:window.GameConstants.Wizard.speed,sprite:s[0],state:0,type:0,width:window.GameConstants.Wizard.width,x:window.GameConstants.Wizard.getX(t),y:window.GameConstants.Wizard.getY(e)}),i}},l=function(e){this.container=e,this.canvas=document.createElement("canvas"),this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._pauseListener=this._pauseListener.bind(this),this.setDeactivated(!1)};l.prototype={level:0,setDeactivated:function(e){this._deactivated!==e&&(this._deactivated=e,e?this._removeGameListeners():this._initializeGameListeners())},getInitialState:function(){return{currentStatus:r.CONTINUE,garbage:[],lastUpdated:null,keysPressed:{ESC:!1,LEFT:!1,RIGHT:!1,SPACE:!1,UP:!1},levelStartTime:null,objects:[],startTime:null}},initializeLevelAndStart:function(e){(e=void 0===e||e)||!this.state?(this._imagesArePreloaded=void 0,this.state=this.getInitialState(),this.state=d[this.level](this.state)):this.state.currentStatus=r.CONTINUE,this.state.levelStartTime=Date.now(),this.state.startTime||(this.state.startTime=this.state.levelStartTime),this._preloadImagesForLevel(function(){this.render(),this._initializeGameListeners(),this.update()}.bind(this))},pauseLevel:function(e){e&&(this.state.currentStatus=e),this.state.keysPressed.ESC=!1,this.state.lastUpdated=null,this._removeGameListeners(),window.addEventListener("keydown",this._pauseListener),this._drawPauseScreen()},_pauseListener:function(e){if(32===e.keyCode&&!this._deactivated){e.preventDefault();var t=this.state.currentStatus===r.WIN||this.state.currentStatus===r.FAIL;this.initializeLevelAndStart(t),window.removeEventListener("keydown",this._pauseListener)}},_drawPauseScreen:function(){var e;switch(this.state.currentStatus){case r.WIN:if(window.renderStatistics){var t=this._generateStatistics(new Date-this.state.startTime),i=this._shuffleArray(Object.keys(t));return void window.renderStatistics(this.ctx,i,i.map((function(e){return t[e]})))}e="Вы победили Газебо!\nУра!";break;case r.FAIL:e="Вы проиграли!";break;case r.PAUSE:e="Игра на паузе!\nНажмите Пробел, чтобы продолжить";break;case r.INTRO:e="Добро пожаловать!\nНажмите Пробел для начала игры"}this._drawMessage(e)},_generateStatistics:function(e){for(var t={Вы:e},s=0;s<i.length;s++){var n=e+(3e3*Math.random()-1500);n<1e3&&(n=1e3),t[i[s]]=n}return t},_shuffleArray:function(e){for(var t=e.length-1;t>0;t--){var i=Math.floor(Math.random()*(t+1)),s=e[t];e[t]=e[i],e[i]=s}return e},_drawMessage:function(e){var t=this.ctx,i=function(e,i,s,n){t.beginPath(),t.moveTo(e,i),t.lineTo(e+10,i+n/2),t.lineTo(e,i+n),t.lineTo(e+s/2,i+n-10),t.lineTo(e+s,i+n),t.lineTo(e+s-10,i+n/2),t.lineTo(e+s,i),t.lineTo(e+s/2,i+10),t.lineTo(e,i),t.stroke(),t.closePath(),t.fill()};t.fillStyle="rgba(0, 0, 0, 0.7)",i(190,40,320,100),t.fillStyle="rgba(256, 256, 256, 1.0)",i(180,30,320,100),t.fillStyle="#000",t.font="16px PT Mono",e.split("\n").forEach((function(e,i){t.fillText(e,200,80+20*i)}))},_preloadImagesForLevel:function(e){if(void 0===this._imagesArePreloaded&&(this._imagesArePreloaded=[]),this._imagesArePreloaded[this.level])e();else for(var t=Object.keys(s),i=t.length,n=this,a=function(t){var s=new Image(t.width,t.height);s.onload=function(){t.image=s,0==--i&&(n._imagesArePreloaded[n.level]=!0,e())},s.src=t.url},r=0;r<t.length;r++)a(s[t[r]])},updateObjects:function(e){var t=this.state.objects.filter((function(e){return 0===e.type}))[0];this.state.keysPressed.SHIFT&&(this.state.objects.push({direction:t.direction,height:window.GameConstants.Fireball.size,speed:window.GameConstants.Fireball.speed(!!(1&t.direction)),sprite:s[1],type:1,width:window.GameConstants.Fireball.size,x:2&t.direction?t.x+t.width:t.x-window.GameConstants.Fireball.size,y:t.y+t.height/2}),this.state.keysPressed.SHIFT=!1),this.state.garbage=[];var i=this.state.objects.filter((function(t){return a[t.type](t,this.state,e),1!==t.state||(this.state.garbage.push(t),!1)}),this);this.state.objects=i},checkStatus:function(){if(this.state.currentStatus===r.CONTINUE){this.commonRules||(this.commonRules=[function(e){return 1===e.objects.filter((function(e){return 0===e.type}))[0].state?r.FAIL:r.CONTINUE},function(e){return e.keysPressed.ESC?r.PAUSE:r.CONTINUE},function(e){return Date.now()-e.startTime>18e4?r.FAIL:r.CONTINUE}]);for(var e=this.commonRules.concat(o[this.level]),t=r.CONTINUE;t===r.CONTINUE&&e.length;)t=e.shift()(this.state);this.state.currentStatus=t}},setGameStatus:function(e){this.state.currentStatus!==e&&(this.state.currentStatus=e)},render:function(){this.ctx.clearRect(0,0,t,e),this.state.objects.forEach((function(e){if(e.sprite){var t=1&e.direction,i=s[e.type+(t?n:"")]||s[e.type];this.ctx.drawImage(i.image,e.x,e.y,e.width,e.height)}}),this)},update:function(){this.state.lastUpdated||(this.state.lastUpdated=Date.now());var e=(Date.now()-this.state.lastUpdated)/10;switch(this.updateObjects(e),this.checkStatus(),this.state.currentStatus){case r.CONTINUE:this.state.lastUpdated=Date.now(),this.render(),requestAnimationFrame(function(){this.update()}.bind(this));break;case r.WIN:case r.FAIL:case r.PAUSE:case r.INTRO:this.pauseLevel()}},_onKeyDown:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!0;break;case 39:this.state.keysPressed.RIGHT=!0;break;case 38:this.state.keysPressed.UP=!0;break;case 27:this.state.keysPressed.ESC=!0}e.shiftKey&&(this.state.keysPressed.SHIFT=!0)},_onKeyUp:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!1;break;case 39:this.state.keysPressed.RIGHT=!1;break;case 38:this.state.keysPressed.UP=!1;break;case 27:this.state.keysPressed.ESC=!1}e.shiftKey&&(this.state.keysPressed.SHIFT=!1)},_initializeGameListeners:function(){window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp)},_removeGameListeners:function(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp)}},l.Verdict=r;var c=new l(document.querySelector(".demo"));return window.restartGame=function(e,t){s[0].url=e,s[0+n].url=t,c.initializeLevelAndStart(),c.setGameStatus(r.INTRO)},window.restartGame("img/wizard.gif","img/wizard-reversed.gif"),c}()})();